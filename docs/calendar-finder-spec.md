# 空き時間みえーるくん - 仕様書

## 概要
GoogleカレンダーのfreeBusy APIを使用して空き時間を抽出し、訪問用リストまたはメール候補テンプレートとして提供する機能。

## UIワイヤーフレーム（モバイル優先）

### 画面A：ポータル（空き時間）

```
[ヘッダー]  空き時間みえーるくん    [⚙ 設定]

[モード切替]  訪問用 | メール候補      ← タブ（デフォルト：訪問用）

[期間チップ（横スクロール・1行）]
  今週  来週  再来週  1ヶ月後

--（期間チップをタップしたら以下の「結果ビュー」に置き換え、チップは非表示）--

[結果ヘッダー]
  今週                           [コピー]

[日別リスト（モバイル可読、1日最大3行）]
  07/29(火)
   ・10:00〜11:00
   ・15:30〜16:00
  07/30(水)
   （空きなし）
  07/31(木)
   ・09:00〜10:30
   ・14:00〜15:00

[戻りリンク]  ← 期間を選び直す
```

**モバイル可読ルール**
- 本文12–14px、行間1.6、日付は太字
- 同日スロットは2列化せず**縦並び**
- 長すぎる日は「…他n件」を自動要約（タップで展開）

### 画面B：設定

```
[ヘッダー] 設定                         [保存]

[業務時間]   平日 ☑ 08:00 〜 18:00   （曜日個別編集ボタン）
[所要時間]   30 / 45 / 60 / 90 / 120 分  （任意入力可）
[移動バッファ]  0 / 15 / 30 / 45 / 60 分
[無視キーワード]  ["社内","仮押さえ"]  （+追加）  [ON/OFF]
[メール書式テンプレ]
  （テキストエリア：トークン例 yy/mm/dd, (曜), HH:mm）
  [プレビューを表示]

[タイムゾーン]  デフォルト(カレンダーTZ)  ▼

[接続] Googleアカウント  ✅  （解除/再接続）
```

## API I/F

### 1) 空き時間取得
`POST /api/availability/query`

**リクエスト**
```json
{
  "period": "this_week",
  "tz": "Asia/Tokyo",
  "settingsOverride": {
    "businessHours": {"mon":{"start":"08:00","end":"18:00"}},
    "durationMin": 60,
    "travelBufferMin": 30,
    "ignoreKeywords": {"enabled": true, "list": ["社内","仮押さえ"]}
  }
}
```

**レスポンス**
```json
{
  "period": "this_week",
  "tz": "Asia/Tokyo",
  "days": [
    {"date":"2025-07-29","weekday":"火",
     "slots":[{"start":"10:00","end":"11:00"}]}
  ]
}
```

### 2) テキスト整形（Gemini）
`POST /api/availability/format`

**リクエスト**
```json
{
  "mode": "visit",
  "periodLabel": "今週",
  "freeDays": [{"date":"2025-07-29","weekday":"火","slots":[{"start":"10:00","end":"11:00"}]}],
  "mailTemplate": "（任意）",
  "maxItems": 6
}
```

**レスポンス（visit）**
```json
{"text": "今週\n07/29(火)\n・10:00〜11:00\n..."}
```

**レスポンス（mail）**
```json
{
  "subject": "【候補日ご提案】打合せの件",
  "body": "＜候補日＞\n・25/07/29（火）10:00〜11:00／..."
}
```

### 3) 設定
- 取得：`GET /api/settings/me`
- 更新：`PUT /api/settings/me`

## アルゴリズム（busy→free変換）

1. freeBusy APIで期間のBusy区間を取得
2. 応答busy[]をマージ・正規化
3. 無視キーワードで該当Busyを除外
4. 営業日・業務時間でクリップ
5. travelBufferMinを前後に適用
6. durationMin以上のFreeのみ抽出
7. 15分刻みに丸め、DaySlots[]へ

## Claude学習パック

### System（役割）
あなたは営業アシスタントAI。入力として受け取る「空き時間のJSON」を、
①モバイル閲覧向けの日別箇条書き（訪問用）
②メール送信用の定型文（テンプレを埋める）
のどちらかで日本語テキストに整形する。

### Few-shot例

**(A) mode=visit**
```
INPUT:
{"mode":"visit","periodLabel":"今週","freeDays":[
 {"date":"2025-07-29","weekday":"火","slots":[{"start":"10:00","end":"11:00"}]}
]}

OUTPUT:
今週
07/29(火)
・10:00〜11:00
```

**(B) mode=mail**
```
OUTPUT:
件名：打合せ候補日のご提案（来週）

本文：
＜候補日＞
・25/08/05（火）10:00〜11:00
※上記日程が難しい場合は、ご都合のよろしい候補をお知らせください。
```

## 実装ToDo

1. Google OAuth設定
2. `/api/availability/query` 実装
3. `/api/availability/format` 実装（Gemini）
4. フロントエンド画面実装
5. 設定画面実装
6. キャッシュ・エラーハンドリング
